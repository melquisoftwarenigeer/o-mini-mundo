name: Laravel CI/CD Pipeline

on:
  push:
    branches:
      - main
      - develop  # permite que pushes em develop também disparem a pipeline
  pull_request:
    branches:
      - main
      - develop  # ativa a pipeline quando houver PRs para develop

jobs:
  #Job de build e testes da aplicação Laravel
  build:
    runs-on: ubuntu-latest

    steps:
      # Passo 1: Clona o repositório
      - name: Check out the code
        uses: actions/checkout@v2

      #Caching de dependências para acelerar o tempo de execução  
      - name: Cache Composer dependencies
        uses: actions/cache@v3
        with:
          path: ~/.composer/cache
          key: ${{ runner.os }}-composer-${{ hashFiles('**/composer.lock') }}
          restore-keys: |
            ${{ runner.os }}-composer-

      # Passo 2: Configura ambiente PHP
      - name: Set up PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.1'
          extensions: mbstring, bcmath, zip, pdo, pdo_sqlite
          coverage: xdebug

      # Passo 3: Instala dependências PHP
      - name: Install PHP dependencies
        run: |
          composer install --no-interaction --prefer-dist

      # Passo 4: Define ambiente de testes
      - name: Set environment file to testing
        run: |
          cp .env.testing.example .env

      # Passo 5: Configura Node.js (para Vite)
      - name: Set up Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '16'

      # Passo 6: Instala dependências frontend
      - name: Install front-end dependencies
        run: |
          npm install

      # Passo 7: Gera arquivos estáticos (Vite)
      - name: Build front-end assets
        run: |
          npm run build

      # Passo 8: Garante existência do SQLite
      - name: Create SQLite database if not exists
        run: |
          touch database/database.sqlite

      # Passo 9: Roda migrações e testes
      - name: Run migrations and tests
        run: |
          php artisan key:generate --env=testing
          php update-jwt-secret.php
          php artisan migrate
          php artisan test

  # Job de build/push da imagem Docker (executado só se os testes passarem)
  docker_build_and_push:
    runs-on: ubuntu-latest
    needs: build  # Executa somente se o job 'build' for bem-sucedido

    steps:
      # Passo 1: Clona novamente o repositório (obrigatório em jobs separados)
      - name: Checkout repository
        uses: actions/checkout@v2

      # Passo 2: Loga no Docker Hub com secrets do GitHub
      - name: Log in to Docker Hub
        run: echo "${{ secrets.DOCKER_PASSWORD }}" | docker login -u "${{ secrets.DOCKER_USERNAME }}" --password-stdin

      # Passo 3: Builda a imagem Docker da aplicação
      - name: Build Docker image
        run: |
          docker build -t melquidocker/o-mini-mundo:latest -f dockerfiles/php/Dockerfile .

      # Passo 4: Envia a imagem ao Docker Hub
      - name: Push Docker image
        run: |
          docker push melquidocker/o-mini-mundo:latest
